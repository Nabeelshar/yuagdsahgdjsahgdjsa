application.register("fictioneer-chapter",class extends Stimulus.Controller{static get targets(){return["bookmarkScroll","contentWrapper","index","content"]}static values={chapterId:Number,storyId:Number};startClick=0;lastToolsParagraph=null;tools=_$$$("paragraph-tools");progressBar=_$(".progress__bar");hasPassword=!!_$("article._password");checkmarkUpdated=!1;checkboxProgressBar=_$$$("site-setting-chapter-progress-bar");checkboxMinimalist=_$$$("site-setting-minimal");initialize(){this.progressBar&&this.hasContentTarget&&!this.hasPassword&&(this.trackProgress(),window.addEventListener("scroll.rAF",FcnUtils.throttle(this.trackProgress.bind(this),1e3/48)))}connect(){window.FictioneerApp.Controllers.fictioneerChapter=this,this.hasIndexTarget&&this.indexTargets.forEach((t=>{t.querySelector(`[data-id="${this.chapterIdValue}"]`)?.classList.add("current")}))}clickOutside({detail:{target:t}}){this.lastToolsParagraph&&!t.closest(".selected-paragraph")&&this.closeTools()}scrollToBookmark(){const t=window.FictioneerApp.Controllers.fictioneerBookmarks;if(!t)return void fcn_showNotification("Error: Bookmarks Controller not connected.",3,"warning");const e=t.data()?.[`ch-${this.chapterIdValue}`]?.["paragraph-id"];if(!e)return;const a=_$(`[data-paragraph-id="${e}"]`);a?.scrollIntoView({behavior:"smooth"})}openFullscreen(){document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen()}closeFullscreen(){document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}toggleTools(t){FcnFormatting.get()["show-paragraph-tools"]&&this.tools?(this.lastToolsParagraph?.classList.remove("selected-paragraph"),this.lastToolsParagraph!==t?(this.lastToolsParagraph=t,t.classList.add("selected-paragraph"),t.append(this.tools)):this.closeTools()):this.lastToolsParagraph&&this.closeTools()}closeTools(){this.lastToolsParagraph?.classList.remove("selected-paragraph"),this.lastToolsParagraph=null}fastClick(t){""==window.getSelection().toString()&&(this.startClick=Date.now(),document.addEventListener("mouseup",(()=>{Date.now()<this.startClick+400&&this.#t(t.target)&&this.tools&&this.toggleTools(t.target.closest("p"))}),{once:!0}))}quote(t){const e=t.target.closest("p[data-paragraph-id]");if(!e)return;const a=window.getSelection()?window.getSelection().toString().trim():"",n=`[anchor]${e.id}[/anchor]`;let o=FcnUtils.extractTextNodes(e);if(o.length>16&&a.replace(/\s/g,"").length){const t=Math.ceil(.25*a.length);let e=fictioneer_tl.partial.quoteFragmentPrefix,n=fictioneer_tl.partial.quoteFragmentSuffix;a.startsWith(o.substring(0,t+1))&&(e=""),a.endsWith(o.substring(o.length-t,o.length))&&(n=""),o=`${e}${a}${n}`}fcn_showNotification(fictioneer_tl.notification.quoteAppendedToComment),FcnUtils.appendToComment(`\n[quote]${o} ${n}[/quote]\n`)}toggleBookmark({target:t}){const e=window.FictioneerApp.Controllers.fictioneerBookmarks;e?(e.toggle(t.closest("p[data-paragraph-id]").dataset.paragraphId,t.closest("[data-color]")?.dataset.color??"none"),window.matchMedia("(min-width: 1024px)").matches&&this.closeTools()):fcn_showNotification("Error: Bookmarks Controller not connected.",3,"warning")}copyLink(t){const e=t.target.closest("p[data-paragraph-id]");e&&FcnUtils.copyToClipboard(`${location.protocol}//${location.host}${location.pathname}#${e.id}`,fictioneer_tl.notification.linkCopiedToClipboard)}toggleIndexOrder({currentTarget:t}){const e=t.closest(".chapter-index");e.dataset.order="asc"===e.dataset.order?"desc":"asc"}trackProgress(){if(!this.progressBar||!this.hasContentTarget||this.hasPassword||this.checkboxMinimalist.checked||!(this.checkboxProgressBar?.checked??1))return;const t=this.contentTarget.getBoundingClientRect(),e=t.height,a=e-t.bottom-Math.max(t.top,0)+window.innerHeight;let n=100*a/e;if(document.body.classList.toggle("hasProgressBar",!(n<0||a>e+500)),n=FcnUtils.clamp(0,100,n),this.progressBar.style.width=`${n}%`,!this.checkmarkUpdated&&this.hasStoryIdValue&&this.storyIdValue&&n>=100&&FcnUtils.loggedIn()){if(this.checkmarkUpdated=!0,!this.hasChapterIdValue||!this.chapterIdValue||"function"!=typeof fcn_toggleCheckmark)return;fcn_toggleCheckmark(this.storyIdValue,this.chapterIdValue,!0)}}#t(t){return!(t.classList.contains("spoiler")||!t.closest("p[data-paragraph-id]")?.textContent.trim().length||!t.closest("p")?.parentElement?.classList.contains("tools-wrapper")||t.closest(".popup-menu-toggle, .skip-tools, .tts-interface, .paragraph-tools__actions, .hidden, .inside-epub, a, button, label, input, textarea, select, option"))}}),application.register("fictioneer-chapter-formatting",class extends Stimulus.Controller{static get targets(){return["fontSizeReset","fontSizeRange","fontSizeText","siteWidthReset","siteWidthRange","siteWidthText","fontSaturationReset","fontSaturationRange","fontSaturationText","letterSpacingReset","letterSpacingRange","letterSpacingText","lineHeightReset","lineHeightRange","lineHeightText","paragraphSpacingReset","paragraphSpacingRange","paragraphSpacingText"]}connect(){this.#e(),this.#a(),this.#n(),this.#o(),this.#s(),this.#r()}siteWidth({currentTarget:t,params:{type:e}}){const a="reset"===e?null:parseInt(t.value);FcnFormatting.updateSiteWidth(a),this.#e(a)}fontSaturation({currentTarget:t,params:{type:e}}){let a=null;switch(e){case"range":a=parseFloat(t.value);break;case"text":a=parseInt(t.value)/100}FcnFormatting.updateFontSaturation(a),this.#n(a)}fontSize({currentTarget:t,params:{type:e}}){const a=FcnFormatting.get();let n=null;switch(e){case"adjust":n=parseFloat(a["font-size"])+parseFloat(t.dataset.modifier);break;case"range":case"text":n=t.value}FcnFormatting.updateFontSize(n),this.#a(n)}letterSpacing({currentTarget:t,params:{type:e}}){let a="reset"===e?null:parseFloat(t.value);FcnFormatting.updateLetterSpacing(a),this.#o(a)}lineHeight({currentTarget:t,params:{type:e}}){let a="reset"===e?null:parseFloat(t.value);FcnFormatting.updateLineHeight(a),this.#s(a)}paragraphSpacing({currentTarget:t,params:{type:e}}){let a="reset"===e?null:parseFloat(t.value);FcnFormatting.updateParagraphSpacing(a),this.#r(a)}#a(t=null){this.#i("font-size",t)}#n(t=null){this.#i("font-saturation",t,(t=>parseInt(100*t)))}#e(t=null){this.#i("site-width",t)}#o(t=null){this.#i("letter-spacing",t)}#s(t=null){this.#i("line-height",t)}#r(t=null){this.#i("paragraph-spacing",t)}#i(t,e=null,a=null){e=e??FcnFormatting.get()[t];const n=t.replace(/-([a-z])/g,((t,e)=>e.toUpperCase()));this[`has${n.charAt(0).toUpperCase()+n.slice(1)}RangeTarget`]&&this[`${n}RangeTargets`].forEach((t=>t.value=e)),this[`has${n.charAt(0).toUpperCase()+n.slice(1)}TextTarget`]&&this[`${n}TextTargets`].forEach((t=>t.value=a?a(e):e)),this[`has${n.charAt(0).toUpperCase()+n.slice(1)}ResetTarget`]&&this[`${n}ResetTargets`].forEach((a=>a.classList.toggle("_modified",e!=FcnFormatting.defaults()[t])))}});const fcn_chapterKeyboardNavigation=t=>{if(["INPUT","TEXTAREA","SELECT","OPTION"].includes(t.target.tagName)||t.target.isContentEditable)return;const e={ArrowLeft:"a.button._navigation._prev",ArrowRight:"a.button._navigation._next"};if(!e[t.code])return;const a=_$(e[t.code]);a?.href&&(window.location.href=a.href.includes("#start")?a.href:`${a.href}#start`)};if(document.addEventListener("keydown",fcn_chapterKeyboardNavigation),"#start"===window.location.hash){history.replaceState(null,document.title,window.location.pathname);const t=_$(".chapter__article");t&&FcnUtils.scrollTo(t,128)}const FcnFormatting={eFormattingTarget:_$(".chapter-formatting"),defaults:()=>({"font-saturation":0,"font-color":FcnGlobals.fontColors[0].css,"font-name":FcnGlobals.fonts[0].css,"font-size":100,"letter-spacing":0,"line-height":1.7,"paragraph-spacing":1.5,"site-width":document.documentElement.dataset.siteWidthDefault??"960",indent:!0,"show-sensitive-content":!0,"show-chapter-notes":!0,justify:!1,"show-comments":!0,"show-paragraph-tools":!0,timestamp:1664797604825,...FcnUtils.parseJSON(document.documentElement.dataset.defaultFormatting??"{}")}),get(){let t=FcnUtils.parseJSON(localStorage.getItem("fcnChapterFormatting"))??FcnFormatting.defaults();return Object.keys(t).length<15&&(t=FcnFormatting.defaults(),FcnFormatting.set(t)),t.timestamp<1651164557584&&(t=FcnFormatting.defaults(),t.timestamp=Date.now(),FcnFormatting.set(t)),t},set(t){"object"==typeof t&&localStorage.setItem("fcnChapterFormatting",JSON.stringify(t))},updateFontSize(t,e=!0){const a=this.get();t=FcnUtils.clamp(50,200,t??FcnFormatting.defaults()["font-size"]),_$$(".resize-font").forEach((e=>{e.style.fontSize=`${t}%`})),a["font-size"]=t,e&&this.set(a)},updateSiteWidth(t,e=!0){const a=FcnFormatting.get(),n=_$("main");t=FcnUtils.clamp(640,1920,t??FcnFormatting.defaults()["site-width"]),n.style.setProperty("--site-width",`${t}px`),n.classList.toggle("_default-width",t==document.documentElement.dataset.siteWidthDefault),n.classList.toggle("_below-1024",t<1024&&t>=768),n.classList.toggle("_below-768",t<768&&t>640),n.classList.toggle("_640-and-below",t<=640),a["site-width"]=t,e&&FcnFormatting.set(a)},updateFontSaturation(t,e=!0){const a=FcnFormatting.get();t=FcnUtils.clamp(-1,1,t??FcnFormatting.defaults()["font-saturation"]),this.eFormattingTarget.style.setProperty("--font-saturation",`(${t>=0?1+t**2:1-t**2} + var(--font-saturation-offset))`),a["font-saturation"]=t,e&&FcnFormatting.set(a)},updateLetterSpacing(t,e=!0){const a=FcnFormatting.get();t=FcnUtils.clamp(-.1,.2,t??FcnFormatting.defaults()["letter-spacing"]),this.eFormattingTarget.style.letterSpacing=`calc(${t}em + var(--font-letter-spacing-base))`,a["letter-spacing"]=t,e&&FcnFormatting.set(a)},updateLineHeight(t,e=!0){const a=FcnFormatting.get();t=FcnUtils.clamp(.8,3,t??FcnFormatting.defaults()["line-height"]),this.eFormattingTarget.style.lineHeight=`${t}`,a["line-height"]=t,e&&FcnFormatting.set(a)},updateParagraphSpacing(t,e=!0){const a=FcnFormatting.get();t=FcnUtils.clamp(0,3,t??FcnFormatting.defaults()["paragraph-spacing"]),this.eFormattingTarget.style.setProperty("--paragraph-spacing",`${t}em`),a["paragraph-spacing"]=t,e&&FcnFormatting.set(a)}};function fcn_updateToggle(t,e,a,n={}){const o=FcnFormatting.get();n={save:!0,...n};const s=Boolean(t),r=_$(e);if(r&&(r.checked=s,r.closest("label").setAttribute("aria-checked",s)),n.toggleClass&&FcnFormatting.eFormattingTarget.classList.toggle(n.toggleClass,n.invertClass?!s:s),n.sensitiveContent){const t=_$$$("inline-sensitive-content-toggle");t?.classList.toggle("hide-sensitive",!s),t?.setAttribute("aria-checked",!s)}n.notes&&_$$(".chapter-note-hideable").forEach((t=>{t.classList.toggle("hidden",!s)})),n.comments&&_$$(".chapter-comments-hideable").forEach((t=>{t.classList.toggle("hidden",!s)})),o[a]=s,n.save&&FcnFormatting.set(o)}(()=>{if(!FcnFormatting.eFormattingTarget)return;const t=FcnFormatting.get();FcnFormatting.updateSiteWidth(t["site-width"],!1),FcnFormatting.updateFontSize(t["font-size"],!1),FcnFormatting.updateFontSaturation(t["font-saturation"],!1),FcnFormatting.updateLetterSpacing(t["letter-spacing"],!1),FcnFormatting.updateLineHeight(t["line-height"],!1),FcnFormatting.updateParagraphSpacing(t["paragraph-spacing"],!1)})(),(()=>{"use strict";const t=_$$$("reader-settings-font-color-reset"),e=_$$$("reader-settings-font-color-select");if(!t)return;function a(a,n=!0){const o=FcnFormatting.get();a=FcnUtils.clamp(0,FcnGlobals.fontColors.length-1,a),t.classList.toggle("_modified",a>0),e.value=a,FcnFormatting.eFormattingTarget.style.setProperty("--text-chapter",FcnGlobals.fontColors[a].css),o["font-color"]=FcnGlobals.fontColors[a].css,n&&FcnFormatting.set(o)}t.onclick=()=>{a(0)},e.onchange=t=>{a(t.target.value)},_$$(".font-color-stepper").forEach((t=>{t.addEventListener("click",(t=>{!function(t=1){let n=(e.selectedIndex+parseInt(t))%FcnGlobals.fontColors.length;n=n<0?FcnGlobals.fontColors.length-1:n,a(n)}(t.currentTarget.value)}))}));const n=FcnFormatting.get();a(FcnGlobals.fontColors.findIndex((t=>t.css==n["font-color"])),!1)})(),(()=>{"use strict";const t=_$$$("reader-settings-font-reset"),e=_$$$("reader-settings-font-select");if(!t)return;function a(n,o=!0){const s=FcnFormatting.get();n=FcnUtils.clamp(0,FcnGlobals.fonts.length-1,n);let r=FcnGlobals.fonts[n].css;FcnGlobals.fonts[n].alt&&(r=`${r}, ${FcnGlobals.fonts[n].alt}`),n<0?a(0):(t.classList.toggle("_modified",n>0),e.value=n,_$$(".chapter-font-family").forEach((t=>{t.style.fontFamily=""===r?"var(--ff-system)":r+", var(--ff-system)"})),s["font-name"]=FcnGlobals.fonts[n].css,o&&FcnFormatting.set(s))}t.onclick=()=>{a(0)},e.onchange=t=>{a(t.target.value)},_$$(".font-stepper").forEach((t=>{t.addEventListener("click",(t=>{!function(t=1){let n=(e.selectedIndex+parseInt(t))%FcnGlobals.fonts.length;n=n<0?FcnGlobals.fonts.length-1:n,a(n)}(t.currentTarget.value)}))}));const n=FcnFormatting.get();a(FcnGlobals.fonts.findIndex((t=>t.css==n["font-name"])),!1)})(),_$$("#reader-settings-indent-toggle").forEach((t=>{const e={invertClass:!0,toggleClass:"no-indent"},a="indent";t.onclick=n=>{fcn_updateToggle(n.currentTarget.checked,`#${t.id}`,a,e)};fcn_updateToggle(FcnFormatting.get()[a],`#${t.id}`,a,{save:!1,...e})})),_$$("#reader-settings-justify-toggle").forEach((t=>{const e={toggleClass:"justify"},a="justify";t.onclick=n=>{fcn_updateToggle(n.currentTarget.checked,`#${t.id}`,a,e)};fcn_updateToggle(FcnFormatting.get()[a],`#${t.id}`,a,{save:!1,...e})})),_$$("#reader-settings-paragraph-tools-toggle").forEach((t=>{const e="show-paragraph-tools";t.onclick=a=>{fcn_updateToggle(a.currentTarget.checked,`#${t.id}`,e)};fcn_updateToggle(FcnFormatting.get()[e],`#${t.id}`,e,{save:!1})})),_$$("#reader-settings-chapter-notes-toggle").forEach((t=>{const e={notes:!0},a="show-chapter-notes";t.onclick=n=>{fcn_updateToggle(n.currentTarget.checked,`#${t.id}`,a,e)};fcn_updateToggle(FcnFormatting.get()[a],`#${t.id}`,a,{save:!1,...e})})),_$$("#reader-settings-comments-toggle").forEach((t=>{const e={comments:!0},a="show-comments";t.onclick=n=>{fcn_updateToggle(n.currentTarget.checked,`#${t.id}`,a,e)};fcn_updateToggle(FcnFormatting.get()[a],`#${t.id}`,a,{save:!1,...e})})),_$$("#reader-settings-sensitive-content-toggle").forEach((t=>{const e={toggleClass:"hide-sensitive",invertClass:!0,sensitiveContent:!0},a="show-sensitive-content";t.onclick=n=>{fcn_updateToggle(n.currentTarget.checked,`#${t.id}`,a,e)};fcn_updateToggle(FcnFormatting.get()[a],`#${t.id}`,a,{save:!1,...e})}));